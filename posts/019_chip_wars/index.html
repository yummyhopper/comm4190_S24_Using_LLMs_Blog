<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.54">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Max Orenstein">
<meta name="dcterms.date" content="2024-07-10">
<meta name="description" content="If you’re interested in learning about the historical technological moment we’re living in today, this book is for you">

<title>Book Review: Chip Wars by Chris Miller – Max’s Blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Max’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://yummyhopper.github.io/comm4190_S24_Using_LLMs_Blog/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/max-orenstein-159b8a237/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Book Review: Chip Wars by Chris Miller</h1>
                  <div>
        <div class="description">
          If you’re interested in learning about the historical technological moment we’re living in today, this book is for you
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Chips</div>
                <div class="quarto-category">Book Review</div>
                <div class="quarto-category">Geopolitics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Max Orenstein </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 10, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="book-review-chip-wars-by-chris-miller" class="level1">
<h1>Book Review: Chip Wars by Chris Miller</h1>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="cover.jpg" class="img-fluid figure-img"></p>
<figcaption>Chip Wars cover</figcaption>
</figure>
</div>
<p>When I began reading this book I knew very little about computer chips. I became interested in the subject mostly because of the press coverage around AI and NVIDIA which recently became one of the biggest companies in the world out of seemingly nowhere. I had little technical knowledge about what chips do, little understanding of their global economic performance, and no awareness of their importance in global security and military applications. I know a little more after reading Chip Wars by Chris Miller, and I hope to share this knowledge I’ve gained in this post as well as my own thoughts.</p>
<section id="not-a-potato-chip" class="level3">
<h3 class="anchored" data-anchor-id="not-a-potato-chip">Not a Potato Chip</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="moores_law.png" class="img-fluid figure-img"></p>
<figcaption>Moore’s Law</figcaption>
</figure>
</div>
<p>What’s essential to understand is that historically, the improvement of computer chips more or less has coincided with the growth of technology we’ve seen in the past half-decade or so. In 1965 founder of Intel Gordon Moore predicted that the number of transistors per semiconductor chip would roughly double each year, and that this continual progress in hardware would give rise to unimaginable technologies such as personal computers and handheld devices. Moore’s law as it has since been coined has indeed held, and has showed no signs of slowing despite the repetitious bending of physics and monumental global supply chain required to manufacture these chips at scale.</p>
<p>If you’re like me before reading this book you may be thinking “Ok, cool. But what the *#%$ is a transistor, why are they getting smaller, and what does it matter?” A transistor is a microscopic electronic switch that has two settings: one and zero. If you stuff enough of these minature switches on a silicon wafer, they connect together and form messages in binary. This is the crux of the interaction between hardware and software, and thus it follows that the more complex messages these computer chips can send, the more advanced the task that can be executed on an electronic device.</p>
<p>This is a vastly oversimplified explanation, but one that makes sense to me. There are many different types of chips optimized for different tasks. Logic chips, memory chips, CPUs, GPUs, TPUs, and a million others that perform different functions. The hot one right now, of course is GPUs, which were initially intended for 3d graphics processing in gaming devices, but due to their state-of-the art parallel processing capabilities have been revolutionary in the field of AI. This is because AI models need to process vast amounts of data and parallel processing allows these tasks to be divided across multiple processors, significantly speeding up computations and making it feasible to work with large datasets in a reasonable time frame.</p>
</section>
<section id="the-worlds-most-complex-supply-chain" class="level3">
<h3 class="anchored" data-anchor-id="the-worlds-most-complex-supply-chain">The World’s Most Complex Supply Chain</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="infographics4.webp" class="img-fluid figure-img"></p>
<figcaption>Global Semiconductor Supply Chain</figcaption>
</figure>
</div>
<p>Not only are semiconductor chips the most complex technology humans have ever made, they also require the most complex supply chain in history to mass produce. Before a chip makes it into your iPhone it passes through several chokepoints that each would topple the global economy at the slightest disruption. Brutally oversimplified these chokepoints are:</p>
<ol type="1">
<li>Design: Firms such as Apple, NVIDIA, Texas Instruments, Intel, Qualcomm, and Arm focus on creating the architecture and blueprints for semiconductor chips. These designs are incredibly intricate, often involving billions of transistors. The design phase is crucial, as it determines the performance, efficiency, and capabilities of the chip. Design firms typically use sophisticated software tools (EDA tools) from companies like Synopsys, Cadence, and Mentor Graphics to develop these complex circuits.</li>
<li>Photolithography: Once the design is complete, it needs to be translated onto silicon wafers. This is where photolithography comes in. Photolithography is a process that uses chemicals and light to print intricate chip designs onto the silicon. As there are more transistors in one of today’s most advanced chips than there is in the human body, this process requires highly specialized, and extraordinarily expensive equipment. Due to the intense level of expertise required to manufacture these machines, one company in Netherlands, ASML, has a near 100% market share in the most advanced extreme ultraviolet (EUV) lithography machines. Just one of these bad boys will run you over $100 million dollars</li>
<li>Manufacturing: The actual production of chips is primarily done by foundries, with Taiwan Semiconductor Manufacturing Company (TSMC) being the most prominent player touting a 92% market share in development of the worlds most advanced chips and Samsung being a far second. It used to be that companies like Intel would manufacture their own chips, but as photolithography and other equipment became increasingly complicated and expensive companies that tried to keep pace in both of these areas were outcompeted. Companies liek TSMC that specialized in manuacturing were able to embed themselves in the supply chain of many different design firms, and produce chips a lot more cost effectively for many more clients.</li>
</ol>
<p>Once you’ve jumped through all of these billion dollar hoops: Congrats! You have a new chip! If you’re lucky it will remain useful for one or two years before a new breakthrough comes along and renders it obsolete.</p>
</section>
<section id="implications-for-global-security" class="level3">
<h3 class="anchored" data-anchor-id="implications-for-global-security">Implications for Global Security</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="taiwan_china_chess.avif" class="img-fluid figure-img"></p>
<figcaption>Taiwan versus China</figcaption>
</figure>
</div>
<blockquote class="blockquote">
<p>“Taiwan isn’t simply the source of the advanced chips that both countries militaries are betting on. It’s the most likely future battleground” - Chris Miller, Chip Wars</p>
</blockquote>
<p>The business of semiconductors is viciously cut-throat. With each decision billions of dollars are at stake and one wrong move could grind some of the world’s most important industries to a screeching halt. That’s why many political commentators believe a Chinese invasion of Taiwan could bring the world economy to its knees. From China’s perspective Taiwan not only plays a crucial role in the global tech market, it also is a threat to national security. After World War II China’s then nationalist government, Kuomintang (or KMT) led by General Chiang Kai-shek siezed Taiwan from the Japanese. When Mao’s Communist party defeated KMT in 1949 Chiang and other leading party officials flead to the island where they ruled for several decades. China points to this history to claim Taiwan which has allied itself with the USA. With such a powerful ally selling them arms a cat and mouse game has played out in the region for the past decade or so between an aggressive China and resilient Taiwan. It’s unclear how a full-scale conflict could escalate, but if it were to it would likely devestate all parties involved. For now China flies jets over Taiwanese airspace, America gives Taiwan weaponry, and Taiwanese forces are drilled constantly as they vigilantly wait to defend their homeland.</p>
<p>What’s fascinating about the relationship between China and Taiwan however, is that they’re mutually dependent. A huge chunk of TSMC’s revenue comes from Chinese companies and almost all of China’s semiconductors come from Taiwan. Furthermore China is deeply embedded in many other parts of the supply chain such as equipment manufacturing that are necessary for TSMC’s continued dominance. And even if China were to successfully invade Taiwan without destroying TSMC’s state-of-the-art fabs, it wouldn’t be so simple to operate them. Again, we’re not talking about potato chips. Semiconductor manufacturing takes a vast amount of technical knowledge and experience to get right as well as managerial excellence and industry knowledge to do efficiently. This tension between the historical significance of the Taiwan China conflict and their simultaneous symbiosis further complicates the issue.</p>
<p>Oh yea, and there’s another wrinkle. Advanced semiconductors are essential for national security, have been for a long time, and will continue to be for as long as Moore’s law holds. Miller actually stumbled into his research on the topic of semiconductors by asking why the US’s weaponry during the Gulf War in 1990 was so much more advanced than the Soviets had managed. The answer, it turned out, was the groundbreaking (now laughably outdated) semiconductors the US was using to guide missiles to their targets far more accurately. Since the 1960s military weapons and communications systems have been getting far smarter due to semiconductors. The race for the world’s most advanced technology is also the race to secure national security. Whoever wins will has a decisive military advantage over the rest of the world.</p>
</section>
<section id="ai-futures" class="level3">
<h3 class="anchored" data-anchor-id="ai-futures">AI Futures</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="intelligence_explosion.webp" class="img-fluid figure-img"></p>
<figcaption>Intelligence Explosion</figcaption>
</figure>
</div>
<blockquote class="blockquote">
<p>The question is, when does the CCP and when does the American national security establishment realize that superintelligence is going to be absolutely decisive for national power? - Leopold Aschenbrenner, <em>Former OpenAI Superalignment Team Member</em></p>
</blockquote>
<p>The field of artificial intelligence has been one of the largest beneficiaries in from the scaleup of computational speed and power. Before the release of ChatGPT on November 30th, 2023 for the vast majority of the public, machines that could think like humans was science fiction. Now leading AI researchers are predicting that we could see artificial superintelligence, a model that outperforms humans on all mental tasks, as early as 2027. While it’s unclear that this is even possible what seems obvious is that the AI models we have now will be the worst we’ve ever used in our lives. As long as Moore’s law holds the AI we have today will be as a iPhone 1 is to an iPhone 14 in the next 20 years… whatever that means. Some experts even believe that this process could be further accelerated if AI learns to train itself. In that case whoever develops the first self-training AI will have enormous adavantages over the rest of the world.</p>
<p>However this looks it seems obvious that this dramatic scaleup will have a tremendous impact in all areas of the global economy. AI piloted fighter jets are already outperforming humans on military drills, AI geo-scanning promises to elevate all sorts of intelligence systems, and AI driven war robots are being developed by top robotics companies. And it’s not just military might, it’s all the economic advantages next gen AI could provide. Right now the advancements in AI are driven primarily by private big tech companies with minimal regulation. The top labs are in the US, China, France, and other parts of Europe. This competitive international dynamic is unlikely to continue if AI becomes as powerful as many believe it can be. Government will be forced to step in and regulate tech companies, groundbreaking international agreements will have to be signed, and the global semiconductor supply chain will be more vital than ever.</p>
<p>The future of technology, specifically artificial intelligence is extremely exciting and terrifying. But really none of the great technological advancements we’ve seen in the past fifty years would have been possible without the advancement of the semiconductor industry. What this book highlighted for me above all else is that we are living in the silicon age. This technological revolution I’ve been living through my entire life is thanks to these incredibly advanced devices that I never though about before reading this book. If you’re interested in learning about the historical technological moment we’re living in today, this book is for you.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/yummyhopper\.github\.io\/comm4190_S24_Using_LLMs_Blog\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>